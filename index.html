<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scraper Builder</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b0f14; color:#e8eef6; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card { background:#111826; border:1px solid #1c2a40; border-radius:14px; padding:16px; }
    h1 { margin:0 0 8px; font-size:22px; }
    .sub { margin:0 0 14px; opacity:.82; }
    h2 { margin: 0 0 10px; font-size: 15px; }
    label { display:block; font-size:12px; opacity:.85; margin: 10px 0 6px; }
    input, textarea, button, select {
      width:100%; box-sizing:border-box;
      border-radius:10px; border:1px solid #243651;
      background:#0f1726; color:#e8eef6;
      padding:10px 12px; outline:none;
    }
    textarea { min-height: 320px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; line-height: 1.4; }
    button { cursor:pointer; border:1px solid #2b425f; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .good { background:#16a34a22; border-color:#22c55e; }
    .primary { background:#1b4dff22; border-color:#2c63ff; }
    .ghost { background:transparent; }
    .pill { display:inline-block; font-size:11px; padding: 4px 8px; border-radius:999px; border:1px solid #2b425f; opacity:.95; }
    .muted { opacity:.78; font-size:12px; }
    .tiny { opacity:.78; font-size:11px; }
    .kbd { border:1px solid #2b425f; border-bottom-width:2px; border-radius:7px; padding: 1px 6px; font-size:11px; opacity:.9; }
    a { color:#9bb7ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .status { margin-top:10px; }
    hr { border:none; border-top:1px solid #1c2a40; margin:14px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
      <div>
        <h1>Scraper Builder <span class="pill">Free • GitHub Pages</span></h1>
        <div class="sub">
          Create bookmarklet → click item + pagination → paste config → generate console script → CSV download.
        </div>
      </div>
      <div class="pill">No backend • No API key</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Step 1 — Create the bookmarklet (copy/paste)</h2>
        <div class="muted">
          Drag-to-bookmarks can be flaky (or blocked by work policy), so do this instead:<br/>
          1) Open Bookmark Manager<br/>
          2) Add new bookmark named <b>Pick selectors</b><br/>
          3) Paste the code below into the bookmark <b>URL</b> field
        </div>

        <label>Bookmarklet URL (copy this)</label>
        <textarea id="bookmarkletCode" style="min-height:140px;"></textarea>

        <div class="btns">
          <button id="copyBookmarklet" class="good">Copy bookmarklet</button>
        </div>

        <div class="tiny muted status" id="pickHelp"></div>

        <hr/>

        <h2>Step 2 — Paste config</h2>
        <label>Picker Output (JSON)</label>
        <textarea id="config" placeholder='Paste JSON here...'></textarea>

        <div class="btns">
          <button id="loadConfig" class="primary">Load config</button>
          <button id="clearConfig" class="ghost">Clear</button>
        </div>

        <div class="status tiny" id="status"></div>

        <hr/>

        <h2>Step 3 — Generate console scraper</h2>

        <label>Row/Card selector</label>
        <input id="rowSelector" placeholder="e.g. li.block-list__item" />

        <label>Item link selector (inside each row)</label>
        <input id="itemSelector" placeholder="e.g. strong.block-list__title a" />

        <label>Pagination mode</label>
        <select id="pagMode">
          <option value="none">None (single page)</option>
          <option value="fetchPages">Fetch page links (recommended)</option>
          <option value="nextButton">Click next (AJAX only)</option>
          <option value="loadMore">Load more button</option>
        </select>

        <label>Pagination selector</label>
        <input id="pagSelector" placeholder='FetchPages: a[href*="/Exhibitors/Index/"] OR nav.pagination a.pagination__item[href]' />

        <div class="btns">
          <button id="copyScript" class="good">Copy script</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Run it on the target page: DevTools → Console → paste → Enter.
        </div>
      </div>

      <div class="card">
        <h2>Generated Script</h2>
        <div class="muted">Scrapes Name + URL and downloads CSV.</div>
        <label>Console Script</label>
        <textarea id="out" spellcheck="false"></textarea>
        <div class="tiny muted">
          Best selectors for that event platform usually are:<br/>
          <code>ROW</code> = <code>li.block-list__item</code><br/>
          <code>ITEM</code> = <code>strong.block-list__title a</code><br/>
          <code>PAGES</code> = <code>a[href*="/Exhibitors/Index/"]</code> (or Speakers/Sponsors)
        </div>
      </div>
    </div>
  </div>

<script>
  function setStatus(msg, ok=true){
    const s=document.getElementById("status");
    s.textContent=msg;
    s.style.color = ok ? "#86efac" : "#fca5a5";
    setTimeout(()=>{ s.textContent=""; s.style.color=""; }, 2500);
  }

  function generateScript({rowSelector, itemSelector, paginationMode, paginationSelector}) {
    if(!rowSelector || !itemSelector) return "// Provide rowSelector and itemSelector.\n";
    const mode = paginationMode || "none";
    const pagSel = paginationSelector || "";

    return `(async () => {
  const ROW_SEL = ${JSON.stringify(rowSelector)};
  const ITEM_SEL = ${JSON.stringify(itemSelector)};
  const MODE = ${JSON.stringify(mode)}; // none | fetchPages | nextButton | loadMore
  const PAGINATION_SEL = ${JSON.stringify(pagSel)};
  const MAX_STEPS = 10; // nextButton only

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const rand = (a,b) => Math.floor(Math.random()*(b-a+1))+a;

  function absUrl(href){
    if(!href) return null;
    try { return new URL(href, location.origin).toString(); } catch { return href; }
  }

  function scrapeFromDoc(doc) {
    const rows = [...doc.querySelectorAll(ROW_SEL)];
    const out = [];
    for (const row of rows) {
      const a = (row.matches && row.matches(ITEM_SEL)) ? row : row.querySelector(ITEM_SEL);
      const name = (a?.textContent || "").trim().replace(/\\s+/g, " ") || null;
      const url = absUrl(a?.getAttribute("href"));
      if (name && url) out.push({ name, url });
    }
    return out;
  }

  async function clickNext(){
    const btn = document.querySelector(PAGINATION_SEL);
    if(!btn) return false;
    btn.click();
    await sleep(rand(700, 1300));
    return true;
  }

  async function clickLoadMore(){
    while(true){
      const btn = document.querySelector(PAGINATION_SEL);
      if(!btn) break;
      if(btn.disabled) break;
      btn.click();
      await sleep(rand(700, 1300));
    }
    return true;
  }

  const map = new Map();

  if (MODE === "fetchPages") {
    const baseUrl = location.origin;

    // Crawl pages: pagination UI may only show 2 links at a time
    const queue = [];
    const seen = new Set();

    function addUrl(u){
      if (!u) return;
      const clean = u.split("#")[0];
      if (!seen.has(clean)) {
        seen.add(clean);
        queue.push(clean);
      }
    }

    // Seed with current page + any links matching PAGINATION_SEL
    addUrl(location.href);
    [...document.querySelectorAll(PAGINATION_SEL)].forEach(a => {
      const href = a.getAttribute("href");
      if(!href) return;
      addUrl(new URL(href, baseUrl).href);
    });

    console.log("Seed pages:", queue.length);

    while (queue.length) {
      const url = queue.shift();
      console.log("Fetching:", url);

      const res = await fetch(url, { credentials: "include" });
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");

      const items = scrapeFromDoc(doc);
      for(const it of items) map.set(it.url, it.name);

      // discover more links on this fetched page
      [...doc.querySelectorAll(PAGINATION_SEL)].forEach(a => {
        const href = a.getAttribute("href");
        if(!href) return;
        addUrl(new URL(href, baseUrl).href);
      });
    }

    console.log("Total pages crawled:", seen.size);

  } else {
    // In-page pagination only (won't work if clicking navigates away)
    let lastSize = 0;

    for (let step=1; step<=MAX_STEPS; step++){
      if(MODE==="loadMore") await clickLoadMore();

      const items = scrapeFromDoc(document);
      for(const it of items) map.set(it.url, it.name);

      console.log(\`Step \${step} — page items: \${items.length} — total unique: \${map.size}\`);

      if(map.size === lastSize) break;
      lastSize = map.size;

      if(MODE==="nextButton"){
        const ok = await clickNext();
        if(!ok) break;
      } else {
        break;
      }

      await sleep(rand(700, 1300));
    }
  }

  const rows = [
    ["Name","URL"],
    ...[...map.entries()].map(([url,name]) => [
      \`"\${String(name).replace(/"/g,'""')}"\`,
      \`"\${url}"\`
    ])
  ];
  const csv = rows.map(r => r.join(",")).join("\\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "export.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  console.log(\`✅ Exported \${map.size} items\`);
})();`;
  }

  function updateOutput() {
    const rowSelector = document.getElementById("rowSelector").value.trim();
    const itemSelector = document.getElementById("itemSelector").value.trim();
    const pagMode = document.getElementById("pagMode").value;
    const pagSelector = document.getElementById("pagSelector").value.trim();

    document.getElementById("out").value = generateScript({
      rowSelector,
      itemSelector,
      paginationMode: pagMode,
      paginationSelector: pagSelector
    });
  }

  function setBookmarkletCode(){
    const pickerUrl = new URL("picker.js", window.location.href).toString();

    const code =
`javascript:(()=>{try{
  const u=${JSON.stringify(pickerUrl)}+"?v="+Date.now();
  const s=document.createElement("script");
  s.src=u; s.async=true;
  s.onload=()=>console.log("[Picker] loaded",u);
  s.onerror=()=>alert("Picker failed to load: "+u);
  document.documentElement.appendChild(s);
}catch(e){alert("Picker error: "+e.message);}})();`;

    document.getElementById("bookmarkletCode").value = code;
    document.getElementById("pickHelp").textContent =
      "On the target site: click the bookmarklet → click item → click pagination. Esc cancels.";

    document.getElementById("copyBookmarklet").onclick = async () => {
      try { await navigator.clipboard.writeText(code); setStatus("Copied bookmarklet ✅"); }
      catch { setStatus("Clipboard blocked — copy manually.", false); }
    };
  }

  document.getElementById("loadConfig").addEventListener("click", () => {
    const txt = document.getElementById("config").value.trim();
    if(!txt) return setStatus("Paste the JSON config first.", false);
    try {
      const cfg = JSON.parse(txt);
      document.getElementById("rowSelector").value = cfg.rowSelector || "";
      document.getElementById("itemSelector").value = cfg.itemSelector || "";
      document.getElementById("pagMode").value = cfg.pagination?.mode || "none";
      document.getElementById("pagSelector").value = cfg.pagination?.selector || "";
      updateOutput();
      setStatus("Loaded config ✅", true);
    } catch {
      setStatus("That doesn’t look like valid JSON.", false);
    }
  });

  document.getElementById("clearConfig").addEventListener("click", () => {
    document.getElementById("config").value = "";
    setStatus("Cleared.");
  });

  ["rowSelector","itemSelector","pagMode","pagSelector"].forEach(id=>{
    document.getElementById(id).addEventListener("input", updateOutput);
    document.getElementById(id).addEventListener("change", updateOutput);
  });

  document.getElementById("copyScript").addEventListener("click", async () => {
    const text = document.getElementById("out").value;
    try { await navigator.clipboard.writeText(text); setStatus("Copied script ✅"); }
    catch { setStatus("Clipboard blocked—copy manually.", false); }
  });

  setBookmarkletCode();
  updateOutput();
</script>
</body>
</html>
