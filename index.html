<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scraper Builder</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b0f14; color:#e8eef6; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card { background:#111826; border:1px solid #1c2a40; border-radius:14px; padding:16px; }
    h1 { margin:0 0 8px; font-size:22px; }
    .sub { margin:0 0 14px; opacity:.82; }
    h2 { margin: 0 0 10px; font-size: 15px; }
    label { display:block; font-size:12px; opacity:.85; margin: 10px 0 6px; }
    input, textarea, button, select {
      width:100%; box-sizing:border-box;
      border-radius:10px; border:1px solid #243651;
      background:#0f1726; color:#e8eef6;
      padding:10px 12px; outline:none;
    }
    textarea { min-height: 260px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; line-height: 1.4; }
    button { cursor:pointer; border:1px solid #2b425f; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .good { background:#16a34a22; border-color:#22c55e; }
    .primary { background:#1b4dff22; border-color:#2c63ff; }
    .ghost { background:transparent; }
    .pill { display:inline-block; font-size:11px; padding: 4px 8px; border-radius:999px; border:1px solid #2b425f; opacity:.95; }
    .muted { opacity:.78; font-size:12px; }
    .tiny { opacity:.78; font-size:11px; }
    .kbd { border:1px solid #2b425f; border-bottom-width:2px; border-radius:7px; padding: 1px 6px; font-size:11px; opacity:.9; }
    hr { border:none; border-top:1px solid #1c2a40; margin:14px 0; }
    code { background:#0a1220; border:1px solid #20304a; padding: 1px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
      <div>
        <h1>Scraper Builder <span class="pill">Free • GitHub Pages</span></h1>
        <div class="sub">
          Non-technical flow: create bookmarklet → click item + pagination → paste config → get a console script (CSV).
        </div>
      </div>
      <div class="pill">No backend • No API key</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Step 1 — Create the bookmarklet (copy/paste)</h2>
        <div class="muted">
          1) Open Chrome <b>Bookmark Manager</b><br/>
          2) Add new bookmark named <b>Pick selectors</b><br/>
          3) Paste the code below into the bookmark <b>URL</b> field
        </div>

        <label>Bookmarklet URL (copy this)</label>
        <textarea id="bookmarkletCode" style="min-height:140px;"></textarea>

        <div class="btns">
          <button id="copyBookmarklet" class="good">Copy bookmarklet</button>
        </div>

        <div class="tiny muted" id="pickHelp" style="margin-top:8px;"></div>

        <hr/>

        <h2>Step 2 — Paste picker output</h2>
        <label>Picker Output (JSON)</label>
        <textarea id="config" placeholder='Paste the JSON you got after clicking item + pagination...'></textarea>

        <div class="btns">
          <button id="loadConfig" class="primary">Load config</button>
          <button id="clearConfig" class="ghost">Clear</button>
        </div>

        <div class="tiny" id="status" style="margin-top:10px;"></div>

        <hr/>

        <h2>Step 3 — Generate console scraper</h2>

        <label>Section name (auto-filled)</label>
        <input id="sectionName" placeholder="Exhibitors | Speakers | Sponsors | Sessions ..." />

        <label>Row/Card selector</label>
        <input id="rowSelector" placeholder="e.g. li.block-list__item" />

        <label>Item link selector (inside each row)</label>
        <input id="itemSelector" placeholder="e.g. strong.block-list__title a" />

        <label>Pagination mode</label>
        <select id="pagMode">
          <option value="indexPages">Index pages (recommended)</option>
          <option value="none">None (single page)</option>
          <option value="fetchPages">Fetch page links (crawl)</option>
          <option value="nextButton">Click next (AJAX only)</option>
          <option value="loadMore">Load more button</option>
        </select>

        <label>Pagination selector</label>
        <input id="pagSelector" placeholder='For indexPages: a[href*="/Exhibitors/Index/"] etc' />

        <div class="btns">
          <button id="copyScript" class="good">Copy script</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Run the generated script on the target page: DevTools → Console → paste → Enter.
        </div>
      </div>

      <div class="card">
        <h2>Generated Script</h2>
        <div class="muted">
          This uses the proven method: collect all <code>/${SECTION}/Index/</code> pages → fetch each → scrape <code>/${SECTION}/Details/</code> links → CSV.
        </div>
        <label>Console Script</label>
        <textarea id="out" spellcheck="false" style="min-height:520px;"></textarea>

        <div class="tiny muted" style="margin-top:10px;">
          Default for this event platform usually works as:<br/>
          <code>Row</code> = <code>li.block-list__item</code><br/>
          <code>Item</code> = <code>strong.block-list__title a</code><br/>
          <code>Pages</code> = <code>a[href*="/Exhibitors/Index/"]</code> (or Speakers/Sponsors)
        </div>
      </div>
    </div>
  </div>

<script>
  function setStatus(msg, ok=true){
    const s=document.getElementById("status");
    s.textContent=msg;
    s.style.color = ok ? "#86efac" : "#fca5a5";
    setTimeout(()=>{ s.textContent=""; s.style.color=""; }, 2500);
  }

  function generateScript({sectionName, rowSelector, itemSelector, paginationMode, paginationSelector}) {
    const SECTION = (sectionName || "").trim();
    if(!SECTION) return "// Provide sectionName (e.g. Exhibitors / Speakers / Sponsors)\n";
    if(!rowSelector || !itemSelector) return "// Provide rowSelector and itemSelector.\n";

    const mode = paginationMode || "indexPages";
    const pagSel = paginationSelector || "";

    return `(async () => {
  const SECTION = ${JSON.stringify(SECTION)};
  const MODE = ${JSON.stringify(mode)}; // indexPages | none | fetchPages | nextButton | loadMore

  const ROW_SEL = ${JSON.stringify(rowSelector)};
  const ITEM_SEL = ${JSON.stringify(itemSelector)};
  const PAGINATION_SEL = ${JSON.stringify(pagSel)};

  const MAX_STEPS = 10; // nextButton only

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const rand = (a,b) => Math.floor(Math.random()*(b-a+1))+a;

  function absUrl(href){
    if(!href) return null;
    try { return new URL(href, location.origin).toString(); } catch { return href; }
  }

  function scrapeRowsFromDoc(doc){
    const rows = [...doc.querySelectorAll(ROW_SEL)];
    const out = [];
    for (const row of rows) {
      const a = (row.matches && row.matches(ITEM_SEL)) ? row : row.querySelector(ITEM_SEL);
      const name = (a?.textContent || "").trim().replace(/\\s+/g, " ") || null;
      const url = absUrl(a?.getAttribute("href"));
      if (name && url) out.push({ name, url });
    }
    return out;
  }

  async function clickNext(){
    const btn = document.querySelector(PAGINATION_SEL);
    if(!btn) return false;
    btn.click();
    await sleep(rand(700, 1300));
    return true;
  }

  async function clickLoadMore(){
    while(true){
      const btn = document.querySelector(PAGINATION_SEL);
      if(!btn) break;
      if(btn.disabled) break;
      btn.click();
      await sleep(rand(700, 1300));
    }
    return true;
  }

  const map = new Map();

  // ✅ This is the original proven pagination method
  if (MODE === "indexPages") {
    const baseUrl = location.origin;

    // If PAGINATION_SEL is empty, default to Index links for the section
    const indexSel = PAGINATION_SEL && PAGINATION_SEL.trim()
      ? PAGINATION_SEL.trim()
      : \`a[href*="/\${SECTION}/Index/"]\`;

    const detailSel = \`a[href^="/\${SECTION}/Details/"]\`;

    const indexPages = [...document.querySelectorAll(indexSel)]
      .map(a => new URL(a.getAttribute("href"), baseUrl).href);

    const uniqueIndexPages = [...new Set(indexPages)];
    console.log("Index pages found:", uniqueIndexPages.length);

    if (uniqueIndexPages.length === 0) {
      console.warn("No Index pages found. Try setting PAGINATION_SEL to a[href*=\"/" + SECTION + "/Index/\"]");
      // Still scrape current page so user gets something
      const items = scrapeRowsFromDoc(document);
      for(const it of items) map.set(it.url, it.name);
    } else {
      for (const url of uniqueIndexPages) {
        console.log("Fetching:", url);
        const res = await fetch(url, { credentials: "include" });
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, "text/html");

        const links = [...doc.querySelectorAll(detailSel)];
        for (const a of links) {
          const name = (a.textContent || "").trim().replace(/\\s+/g, " ");
          const href = a.getAttribute("href");
          if(!name || !href) continue;
          const abs = new URL(href, baseUrl).href;
          map.set(abs, name);
        }
      }
    }

  } else if (MODE === "fetchPages") {
    // Crawl pages by link discovery (fallback mode)
    const baseUrl = location.origin;
    const queue = [];
    const seen = new Set();

    function addUrl(u){
      if(!u) return;
      const clean = u.split("#")[0];
      if(!seen.has(clean)){ seen.add(clean); queue.push(clean); }
    }

    addUrl(location.href);
    [...document.querySelectorAll(PAGINATION_SEL)].forEach(a => {
      const href = a.getAttribute("href");
      if(!href) return;
      addUrl(new URL(href, baseUrl).href);
    });

    console.log("Seed pages:", queue.length);

    while(queue.length){
      const url = queue.shift();
      console.log("Fetching:", url);

      const res = await fetch(url, { credentials: "include" });
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");

      const items = scrapeRowsFromDoc(doc);
      for(const it of items) map.set(it.url, it.name);

      [...doc.querySelectorAll(PAGINATION_SEL)].forEach(a => {
        const href = a.getAttribute("href");
        if(!href) return;
        addUrl(new URL(href, baseUrl).href);
      });
    }

  } else {
    // In-page only (AJAX / load more)
    let lastSize = 0;

    for(let step=1; step<=MAX_STEPS; step++){
      if(MODE==="loadMore") await clickLoadMore();

      const items = scrapeRowsFromDoc(document);
      for(const it of items) map.set(it.url, it.name);

      console.log(\`Step \${step} — page items: \${items.length} — total unique: \${map.size}\`);

      if(map.size === lastSize) break;
      lastSize = map.size;

      if(MODE==="nextButton"){
        const ok = await clickNext();
        if(!ok) break;
      } else {
        break;
      }

      await sleep(rand(700, 1300));
    }
  }

  const rows = [
    ["Name","URL"],
    ...[...map.entries()].map(([url,name]) => [
      \`"\${String(name).replace(/"/g,'""')}"\`,
      \`"\${url}"\`
    ])
  ];
  const csv = rows.map(r => r.join(",")).join("\\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = \`\${SECTION.toLowerCase()}_export.csv\`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  console.log(\`✅ Exported \${map.size} items\`);
})();`;
  }

  function updateOutput() {
    const sectionName = document.getElementById("sectionName").value.trim();
    const rowSelector = document.getElementById("rowSelector").value.trim();
    const itemSelector = document.getElementById("itemSelector").value.trim();
    const pagMode = document.getElementById("pagMode").value;
    const pagSelector = document.getElementById("pagSelector").value.trim();

    document.getElementById("out").value = generateScript({
      sectionName,
      rowSelector,
      itemSelector,
      paginationMode: pagMode,
      paginationSelector: pagSelector
    });
  }

  function setBookmarkletCode(){
    const pickerUrl = new URL("picker.js", window.location.href).toString();

    const code =
`javascript:(()=>{try{
  const u=${JSON.stringify(pickerUrl)}+"?v="+Date.now();
  const s=document.createElement("script");
  s.src=u; s.async=true;
  s.onload=()=>console.log("[Picker] loaded",u);
  s.onerror=()=>alert("Picker failed to load: "+u);
  document.documentElement.appendChild(s);
}catch(e){alert("Picker error: "+e.message);}})();`;

    document.getElementById("bookmarkletCode").value = code;
    document.getElementById("pickHelp").textContent =
      "Use on target site: click the bookmarklet → click an item → click any pagination segment. Esc cancels.";

    document.getElementById("copyBookmarklet").onclick = async () => {
      try { await navigator.clipboard.writeText(code); setStatus("Copied bookmarklet ✅"); }
      catch { setStatus("Clipboard blocked — copy manually.", false); }
    };
  }

  // UI wiring
  document.getElementById("loadConfig").addEventListener("click", () => {
    const txt = document.getElementById("config").value.trim();
    if(!txt) return setStatus("Paste the JSON config first.", false);

    try {
      const cfg = JSON.parse(txt);

      // Fill fields
      document.getElementById("sectionName").value = cfg.sectionName || cfg.section || "";
      document.getElementById("rowSelector").value = cfg.rowSelector || "";
      document.getElementById("itemSelector").value = cfg.itemSelector || "";
      document.getElementById("pagMode").value = (cfg.pagination?.mode || "indexPages");
      document.getElementById("pagSelector").value = (cfg.pagination?.selector || "");

      // Defaults if missing (good for the event platform you’re using)
      if(!document.getElementById("rowSelector").value) document.getElementById("rowSelector").value = "li.block-list__item";
      if(!document.getElementById("itemSelector").value) document.getElementById("itemSelector").value = "strong.block-list__title a";

      updateOutput();
      setStatus("Loaded config ✅", true);
    } catch (e) {
      setStatus("That doesn’t look like valid JSON.", false);
    }
  });

  document.getElementById("clearConfig").addEventListener("click", () => {
    document.getElementById("config").value = "";
    setStatus("Cleared.");
  });

  ["sectionName","rowSelector","itemSelector","pagMode","pagSelector"].forEach(id=>{
    document.getElementById(id).addEventListener("input", updateOutput);
    document.getElementById(id).addEventListener("change", updateOutput);
  });

  document.getElementById("copyScript").addEventListener("click", async () => {
    const text = document.getElementById("out").value;
    try { await navigator.clipboard.writeText(text); setStatus("Copied script ✅"); }
    catch { setStatus("Clipboard blocked—copy manually.", false); }
  });

  // Init
  setBookmarkletCode();
  updateOutput();
</script>
</body>
</html>
