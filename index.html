<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scraper Builder (Free)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b0f14; color:#e8eef6; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card { background:#111826; border:1px solid #1c2a40; border-radius:14px; padding:16px; }
    h1 { margin:0 0 8px; font-size:22px; }
    .sub { margin:0 0 14px; opacity:.82; }
    h2 { margin: 0 0 10px; font-size: 15px; }
    label { display:block; font-size:12px; opacity:.85; margin: 10px 0 6px; }
    input, textarea, button, select {
      width:100%; box-sizing:border-box;
      border-radius:10px; border:1px solid #243651;
      background:#0f1726; color:#e8eef6;
      padding:10px 12px; outline:none;
    }
    textarea { min-height: 340px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; line-height: 1.4; }
    button { cursor:pointer; border:1px solid #2b425f; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .good { background:#16a34a22; border-color:#22c55e; }
    .primary { background:#1b4dff22; border-color:#2c63ff; }
    .ghost { background:transparent; }
    .pill { display:inline-block; font-size:11px; padding: 4px 8px; border-radius:999px; border:1px solid #2b425f; opacity:.9; }
    .muted { opacity:.78; font-size:12px; }
    .tiny { opacity:.78; font-size:11px; }
    .kbd { border:1px solid #2b425f; border-bottom-width:2px; border-radius:7px; padding: 1px 6px; font-size:11px; opacity:.9; }
    code { background:#0a1220; border:1px solid #20304a; padding: 1px 6px; border-radius: 6px; }
    a { color:#9bb7ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .status { margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
      <div>
        <h1>Scraper Builder <span class="pill">Free ‚Ä¢ GitHub Pages</span></h1>
        <div class="sub">Non-technical flow: drag a bookmarklet ‚Üí click an item + pagination ‚Üí paste config ‚Üí get a console script (CSV export).</div>
      </div>
      <div class="pill">No backend ‚Ä¢ No API key</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Step 1 ‚Äî Add the ‚ÄúClick to pick‚Äù bookmarklet</h2>
        <div class="muted">
          1) Show bookmarks bar: <span class="kbd">Ctrl</span>+<span class="kbd">Shift</span>+<span class="kbd">B</span> (Windows) or <span class="kbd">Cmd</span>+<span class="kbd">Shift</span>+<span class="kbd">B</span> (Mac)<br/>
          2) Drag the link below onto your bookmarks bar.
        </div>

        <label>Drag this link to your bookmarks bar</label>
        <a id="bookmarklet" href="#" class="pill" style="display:inline-block; padding:10px 12px;">üü¢ Pick selectors</a>

        <div class="muted" style="margin-top:12px;">
          On the target site: click the bookmark ‚Üí click the item name inside a card ‚Üí then click the ‚ÄúNext / Load more / Page link‚Äù.<br/>
          It will copy a JSON config to clipboard (and also show it on screen).
        </div>

        <div class="status tiny" id="pickHelp"></div>

        <hr style="border:none; border-top:1px solid #1c2a40; margin:14px 0;" />

        <h2>Step 2 ‚Äî Paste the config here</h2>
        <label>Picker Output (JSON)</label>
        <textarea id="config" placeholder='Paste the JSON you got after clicking item + pagination...'></textarea>

        <div class="btns">
          <button id="loadConfig" class="primary">Load config</button>
          <button id="clearConfig" class="ghost">Clear</button>
        </div>

        <div class="status tiny" id="status"></div>

        <hr style="border:none; border-top:1px solid #1c2a40; margin:14px 0;" />

        <h2>Step 3 ‚Äî Generate console scraper</h2>

        <label>Row/Card selector</label>
        <input id="rowSelector" placeholder="e.g. li.block-list__item" />

        <label>Item link selector (inside each row)</label>
        <input id="itemSelector" placeholder="e.g. strong.block-list__title a" />

        <label>Pagination mode</label>
        <select id="pagMode">
          <option value="none">None (single page)</option>
          <option value="nextButton">Next button</option>
          <option value="loadMore">Load more button</option>
        </select>

        <label>Pagination selector (button/link)</label>
        <input id="pagSelector" placeholder='e.g. nav.pagination a[aria-current="true"] + a' />

        <div class="btns">
          <button id="copyScript" class="good">Copy script</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Run it on the target page: DevTools ‚Üí Console ‚Üí paste ‚Üí Enter.
        </div>
      </div>

      <div class="card">
        <h2>Generated Script</h2>
        <div class="muted">This script scrapes item name + item URL and downloads a CSV. It paginates by clicking Next or Load More if configured.</div>
        <label>Console Script</label>
        <textarea id="out" spellcheck="false"></textarea>
        <div class="tiny muted">Tip: test on 1‚Äì2 pages first by reducing MAX_STEPS in the script.</div>
      </div>
    </div>
  </div>

<script>
/**
 * Bookmarklet picker:
 * - user clicks an item link
 * - then clicks a pagination control
 * - we output JSON: rowSelector, itemSelector, pagMode + pagSelector
 */
function makePickerCode() {
  return `(function(){
  const cssEscape = (s)=> (window.CSS&&CSS.escape)?CSS.escape(s):s.replace(/[^a-zA-Z0-9_-]/g,"\\\\$&");
  function stableClasses(el){
    const cls=[...el.classList||[]].filter(c=>c && c.length<40 && !/[0-9]{4,}/.test(c));
    return cls.slice(0,2);
  }
  function selectorFor(el){
    if(!el||el.nodeType!==1) return null;
    if(el.id) return "#"+cssEscape(el.id);
    const parts=[];
    let cur=el;
    while(cur && cur.nodeType===1 && cur!==document.body){
      let part=cur.tagName.toLowerCase();
      const cls=stableClasses(cur);
      if(cls.length) part += "."+cls.map(cssEscape).join(".");
      // fallback to nth-of-type if needed
      if(!cls.length && cur.parentElement){
        const sib=[...cur.parentElement.children].filter(x=>x.tagName===cur.tagName);
        if(sib.length>1){
          part += ":nth-of-type("+(sib.indexOf(cur)+1)+")";
        }
      }
      parts.unshift(part);
      const candidate=parts.join(" > ");
      if(document.querySelectorAll(candidate).length===1) return candidate;
      cur=cur.parentElement;
    }
    return parts.join(" > ");
  }
  function findRepeatingRow(el){
    let cur=el;
    for(let i=0;i<8 && cur;i++){
      const sel=selectorFor(cur);
      if(!sel) break;
      const n=document.querySelectorAll(sel).length;
      if(n>=2 && n<=5000) return sel;
      cur=cur.parentElement;
    }
    return null;
  }
  function makeRelativeItemSelector(rowSel, clickedEl){
    // Try to produce a short selector relative to the row
    // Prefer an anchor if possible
    const a = clickedEl.closest("a[href]") || clickedEl;
    const tag = a.tagName.toLowerCase();
    const cls = stableClasses(a);
    if(cls.length) return tag+"."+cls.map(cssEscape).join(".");
    // fallback: try common patterns
    return "a[href]";
  }

  const state = { step: 1, item: null, rowSel: null, itemSel: null, pagSel: null, pagMode: "none" };

  const overlay=document.createElement("div");
  overlay.style.cssText="position:fixed;inset:0;z-index:2147483647;background:rgba(0,0,0,.08);cursor:crosshair;";
  document.body.appendChild(overlay);

  let last=null;
  function highlight(el){
    if(last) last.style.outline="";
    last=el;
    if(el) el.style.outline="3px solid #22c55e";
  }
  function onMove(e){
    const el=document.elementFromPoint(e.clientX,e.clientY);
    if(el && el!==overlay) highlight(el);
  }
  function cleanup(){
    overlay.removeEventListener("mousemove",onMove,true);
    overlay.removeEventListener("click",onClick,true);
    document.removeEventListener("keydown",onKey,true);
    if(last) last.style.outline="";
    overlay.remove();
  }
  function onKey(e){
    if(e.key==="Escape"){ cleanup(); alert("Picker cancelled."); }
  }

  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text); return true; }catch(e){ return false; }
  }

  function explain(msg){
    console.log(msg);
    overlay.title = msg;
  }

  function onClick(e){
    e.preventDefault(); e.stopPropagation();
    const el=document.elementFromPoint(e.clientX,e.clientY);
    if(!el || el===overlay) return;

    if(state.step===1){
      const rowSel=findRepeatingRow(el);
      const itemSel=makeRelativeItemSelector(rowSel, el);
      state.rowSel=rowSel;
      state.itemSel=itemSel;
      state.step=2;
      alert("‚úÖ Item selected. Now click the pagination control (Next / Load more / Page link).\\nIf there is no pagination, press Esc.");
      return;
    }

    // step 2: pagination click target
    const pagEl = el.closest("a[href], button, [role='button']") || el;
    state.pagSel = selectorFor(pagEl);
    const text = (pagEl.textContent||"").trim().toLowerCase();
    if(text.includes("load") || text.includes("more")) state.pagMode = "loadMore";
    else if(text.includes("next") || text.includes("page") || pagEl.tagName.toLowerCase()==="a") state.pagMode = "nextButton";
    else state.pagMode = "nextButton";

    const payload = {
      rowSelector: state.rowSel,
      itemSelector: state.itemSel,
      pagination: { mode: state.pagMode, selector: state.pagSel }
    };
    const json = JSON.stringify(payload, null, 2);

    cleanup();

    copyToClipboard(json).then(ok=>{
      if(ok) alert("‚úÖ Config copied to clipboard! Paste it into the Scraper Builder page.\\n\\n"+json);
      else prompt("Copy this JSON config:", json);
    });
  }

  overlay.addEventListener("mousemove",onMove,true);
  overlay.addEventListener("click",onClick,true);
  document.addEventListener("keydown",onKey,true);

  alert("üü¢ Picker ON. Click the item name/link inside a card.\\nPress Esc to cancel.");
})();`;
}

function setStatus(msg, ok=true){
  const s=document.getElementById("status");
  s.textContent=msg;
  s.style.color = ok ? "#86efac" : "#fca5a5";
  setTimeout(()=>{ s.textContent=""; s.style.color=""; }, 2500);
}

function generateScript({rowSelector, itemSelector, paginationMode, paginationSelector}) {
  if(!rowSelector || !itemSelector) return "// Provide rowSelector and itemSelector.\n";
  const pagMode = paginationMode || "none";
  const pagSel = paginationSelector || "";

  return `(async () => {
  const ROW_SEL = ${JSON.stringify(rowSelector)};
  const ITEM_SEL = ${JSON.stringify(itemSelector)};
  const PAGINATION_MODE = ${JSON.stringify(pagMode)}; // none | nextButton | loadMore
  const PAGINATION_SEL = ${JSON.stringify(pagSel)};
  const MAX_STEPS = 10; // change if needed

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const rand = (a,b) => Math.floor(Math.random()*(b-a+1))+a;

  function absUrl(href){
    if(!href) return null;
    try { return new URL(href, location.origin).toString(); } catch { return href; }
  }

  function scrapePage() {
    const rows = [...document.querySelectorAll(ROW_SEL)];
    const out = [];
    for (const row of rows) {
      const a = row.querySelector(ITEM_SEL);
      const name = (a?.textContent || "").trim().replace(/\\s+/g, " ") || null;
      const url = absUrl(a?.getAttribute("href"));
      if (name && url) out.push({ name, url });
    }
    return out;
  }

  async function clickNext(){
    const btn = document.querySelector(PAGINATION_SEL);
    if(!btn) return false;
    btn.click();
    await sleep(rand(700, 1300));
    return true;
  }

  async function clickLoadMore(){
    while(true){
      const btn = document.querySelector(PAGINATION_SEL);
      if(!btn) break;
      if(btn.disabled) break;
      btn.click();
      await sleep(rand(700, 1300));
    }
    return true;
  }

  const map = new Map();
  let lastSize = 0;

  for (let step=1; step<=MAX_STEPS; step++){
    if(PAGINATION_MODE==="loadMore") await clickLoadMore();

    const items = scrapePage();
    for(const it of items) map.set(it.url, it.name);

    console.log(\`Step \${step} ‚Äî page items: \${items.length} ‚Äî total unique: \${map.size}\`);

    if(map.size === lastSize) break;
    lastSize = map.size;

    if(PAGINATION_MODE==="nextButton"){
      const ok = await clickNext();
      if(!ok) break;
    } else if(PAGINATION_MODE==="none" || PAGINATION_MODE==="loadMore"){
      // for loadMore we already expanded; stop after one scrape unless it keeps changing
      if(PAGINATION_MODE==="none") break;
      if(step >= MAX_STEPS) break;
    }

    await sleep(rand(700, 1300));
  }

  const rows = [
    ["Name","URL"],
    ...[...map.entries()].map(([url,name]) => [
      \`"\${String(name).replace(/"/g,'""')}"\`,
      \`"\${url}"\`
    ])
  ];
  const csv = rows.map(r => r.join(",")).join("\\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "export.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  console.log(\`‚úÖ Exported \${map.size} items\`);
})();`;
}

function updateOutput() {
  const rowSelector = document.getElementById("rowSelector").value.trim();
  const itemSelector = document.getElementById("itemSelector").value.trim();
  const pagMode = document.getElementById("pagMode").value;
  const pagSelector = document.getElementById("pagSelector").value.trim();

  document.getElementById("out").value = generateScript({
    rowSelector,
    itemSelector,
    paginationMode: pagMode,
    paginationSelector: pagSelector
  });
}

function setBookmarkletLink(){
  const raw = makePickerCode();
  const href = "javascript:" + encodeURIComponent(raw).replace(/%20/g, " ");
  const a = document.getElementById("bookmarklet");
  a.href = href;
  document.getElementById("pickHelp").textContent =
    "Drag the ‚ÄòPick selectors‚Äô pill to your bookmarks bar. Then use it on any site.";
}

// wire UI
document.getElementById("loadConfig").addEventListener("click", () => {
  const txt = document.getElementById("config").value.trim();
  if(!txt) return setStatus("Paste the JSON config first.", false);
  try {
    const cfg = JSON.parse(txt);
    document.getElementById("rowSelector").value = cfg.rowSelector || "";
    document.getElementById("itemSelector").value = cfg.itemSelector || "";
    document.getElementById("pagMode").value = cfg.pagination?.mode || "none";
    document.getElementById("pagSelector").value = cfg.pagination?.selector || "";
    updateOutput();
    setStatus("Loaded config ‚úÖ", true);
  } catch {
    setStatus("That doesn‚Äôt look like valid JSON.", false);
  }
});

document.getElementById("clearConfig").addEventListener("click", () => {
  document.getElementById("config").value = "";
  setStatus("Cleared.");
});

["rowSelector","itemSelector","pagMode","pagSelector"].forEach(id=>{
  document.getElementById(id).addEventListener("input", updateOutput);
  document.getElementById(id).addEventListener("change", updateOutput);
});

document.getElementById("copyScript").addEventListener("click", async () => {
  const text = document.getElementById("out").value;
  try { await navigator.clipboard.writeText(text); setStatus("Copied script ‚úÖ"); }
  catch { setStatus("Clipboard blocked‚Äîcopy manually.", false); }
});

setBookmarkletLink();
updateOutput();
</script>
</body>
</html>
